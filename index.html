<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Our Wedding Registry</title>
  <meta name="description" content="Edward and Caroline are getting married on their 13 year anniversary. Photos, music, and a simple honeymoon registry." />
  <meta property="og:title" content="Edward & Caroline - Wedding" />
  <meta property="og:description" content="We are getting married on our 13 year anniversary. Help us celebrate and, if you like, chip in for the honeymoon." />
  <meta property="og:image" content="assets/photos/edward-1.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <style>
    :root {
      --bg: #f9fafb;
      --card: #ffffff;
      --text: #1a1a1a;
      --muted: #667085;
      --accent1: #EDCD4F;
      --accent2: #49C0B3;
      --accent3: #8FB26F;
      --radius: 16px;
      --shadow: 0 20px 40px rgba(0,0,0,.08);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      color: var(--text);
      background:
        radial-gradient(1100px 700px at 10% -20%, rgba(237,205,79,.25), transparent 60%),
        radial-gradient(900px 800px at 90% 10%, rgba(73,192,179,.25), transparent 60%),
        var(--bg);
      line-height: 1.6;
    }
    a { color: inherit; text-decoration: none; }
    .container { width: min(1100px, 92%); margin: 0 auto; }

    /* Top nav */
    .nav { position: sticky; top: 0; z-index: 20; backdrop-filter: blur(8px); background: rgba(255,255,255,.85); border-bottom: 1px solid rgba(0,0,0,.06); }
    .nav-inner { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; }
    .brand { font-weight: 700; letter-spacing: .3px; }
    .brand .pill { font-size: 12px; margin-left: 8px; padding: 4px 8px; border-radius: 999px; background: rgba(0,0,0,.06); color: var(--muted); }
    .nav a { padding: 8px 10px; border-radius: 8px; color: var(--muted); font-weight: 600; }
    .nav a:hover { color: var(--text); background: rgba(0,0,0,.06); }

    /* Hero */
    .hero { position: relative; padding: 96px 0 72px; text-align: center; overflow: hidden; }
    .hero h1 { font-size: clamp(32px, 6vw, 60px); line-height: 1.08; margin: 0 0 10px; }
    .hero p { color: var(--muted); margin: 6px 0 28px; }
    .tagline { margin: 0 0 8px; font-size: clamp(18px, 2.8vw, 24px); color: var(--muted); text-align: center; }

    .cta { display: inline-flex; align-items: center; gap: 10px; padding: 14px 18px; border-radius: 14px; font-weight: 700; transition: transform .12s ease, box-shadow .12s ease; }
    .cta.primary { background: linear-gradient(135deg, var(--accent1), var(--accent2)); box-shadow: var(--shadow); }
    .cta.primary:hover { transform: translateY(-1px); box-shadow: 0 16px 32px rgba(0,0,0,.12); }
    .cta.secondary { background: rgba(0,0,0,.06); border: 1px solid rgba(0,0,0,.10); }

    /* Magnetic buttons */
    @media (prefers-reduced-motion: no-preference){
      .magnetic{ will-change: transform; transition: transform .08s ease; }
    }

    .card { background: var(--card); border: 1px solid rgba(0,0,0,.08); border-radius: var(--radius); box-shadow: var(--shadow); }
    .card.fancy { background: linear-gradient(var(--card), var(--card)) padding-box,
                  linear-gradient(135deg, var(--accent1), var(--accent2)) border-box; border: 2px solid transparent; }

    /* Sections */
    section { padding: 64px 0; }
    section h2 { font-size: clamp(22px, 3vw, 30px); margin: 0 0 18px; }
    section p.lead { color: var(--muted); margin-top: 0; }

    /* Gallery */
    .gallery-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .gallery-grid img { width: 100%; height: 100%; object-fit: cover; object-position: center; border-radius: 12px; cursor: zoom-in; border: 1px solid rgba(0,0,0,.08); aspect-ratio: 4 / 3; max-height: 420px; transition: transform .35s cubic-bezier(.2,.8,.2,1), box-shadow .35s; }
    .gallery-grid img:hover { transform: scale(1.02); box-shadow: var(--shadow); }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-8 { grid-column: span 8; }
    @media (max-width: 800px) { .col-6, .col-4, .col-8 { grid-column: span 12; } }

    /* Photo scroll reveal (new) */
    .ph-in { opacity: 0; transform: translateY(10px) scale(.985); }
    .ph-on { opacity: 1; transform: none; transition: transform .6s cubic-bezier(.16,1,.3,1), opacity .6s; }

    /* Registry */
    .registry { display: grid; grid-template-columns: 1.2fr .8fr; gap: 18px; align-items: center; }
    .registry .box { padding: 18px; }
    .registry .qr { text-align: center; padding: 18px; }
    .registry .qr img { max-width: 220px; width: 100%; border-radius: 12px; border: 1px solid rgba(0,0,0,.08); }
    @media (max-width: 900px) { .registry { grid-template-columns: 1fr; } }

    /* Music */
    .music { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; align-items: start; }
    @media (max-width: 900px) { .music { grid-template-columns: 1fr; } }
    .tracklist { list-style: none; padding: 0; margin: 0; }
    .tracklist li { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 12px 14px; border-radius: 12px; background: rgba(0,0,0,.035); border: 1px solid rgba(0,0,0,.08); margin-bottom: 10px; }
    .track-controls button { appearance: none; border: 0; padding: 8px 10px; border-radius: 10px; background: rgba(0,0,0,.10); color: var(--text); font-weight: 700; cursor: pointer; }
    .track-controls button:hover { background: rgba(0,0,0,.09); }

    /* Lightbox */
    .lightbox { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.7); z-index: 50; }
    .lightbox.open { display: flex; }
    .lightbox img { max-width: 92vw; max-height: 86vh; border-radius: 12px; box-shadow: var(--shadow); }

    /* Footer */
    footer { padding: 40px 0 60px; color: var(--muted); text-align: center; }

    /* Utility */
    .row { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
    .muted { color: var(--muted); }
    .spacer { height: 8px; }

    /* Divider wave */
    .divider { display: block; width: 100%; height: 90px; margin-top: -40px; }
    .divider path.gold { fill: rgba(237,205,79,.18); }

    /* Button shimmer */
    .cta { position: relative; overflow: hidden; }
    .cta.primary::after { content: ""; position: absolute; inset: 0; border-radius: inherit; background: linear-gradient(120deg, rgba(255,255,255,0) 20%, rgba(255,255,255,.45) 50%, rgba(255,255,255,0) 80%); transform: skewX(-20deg) translateX(-120%); transition: transform .6s; }
    .cta.primary:hover::after { transform: skewX(-20deg) translateX(120%); }

    /* Hero blobs */
    .blobs{ position:absolute; inset:0; z-index:-1; pointer-events:none; }
    .blob{
      position:absolute; width:420px; height:420px; border-radius:50%;
      filter: blur(24px); opacity:.45;
      animation: float 14s ease-in-out infinite alternate;
    }
    .b1{ left:-120px; top:-80px; background: radial-gradient(circle at 30% 30%, rgba(237,205,79,.8), rgba(237,205,79,0)); }
    .b2{ right:-140px; top:-40px; background: radial-gradient(circle at 60% 40%, rgba(73,192,179,.8), rgba(73,192,179,0)); animation-duration: 16s; }
    .b3{ left:30%; bottom:-160px; background: radial-gradient(circle at 40% 60%, rgba(143,178,111,.8), rgba(143,178,111,0)); animation-duration: 18s; }
    @keyframes float{ from{ transform: translateY(-6px) } to{ transform: translateY(8px) } }

    /* Ken Burns */
    @media (prefers-reduced-motion: no-preference){
      .kb{ animation: kenburns 14s ease-in-out infinite alternate; }
      @keyframes kenburns{
        0%{ transform: scale(1) translate3d(0,0,0) }
        100%{ transform: scale(1.06) translate3d(2px,-2px,0) }
      }
    }

    @media (prefers-reduced-motion: reduce){
      .blob{ animation: none }
      .magnetic{ transition: none }
      .kb{ animation: none }
    }
  </style>
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
      <div class="brand">Edward & Caroline <span class="pill">October 8th, 2025</span></div>
      <nav class="row" aria-label="Primary">
        <a href="#home">Home</a>
        <a href="#story">Story</a>
        <a href="#music">Music</a>
        <a href="#gallery">Photos</a>
        <a href="#registry">Registry</a>
      </nav>
    </div>
  </header>

  <main id="home" class="hero container">
    <!-- soft blobs -->
    <div class="blobs" aria-hidden="true">
      <span class="blob b1"></span>
      <span class="blob b2"></span>
      <span class="blob b3"></span>
    </div>

    <h1>We are getting married!</h1>
    <h2 class="tagline">About time, huh??</h2>

    <!-- Countdown -->
    <div id="countdown" class="countdown" aria-label="Countdown to Oct 8, 2025">
      <div><span id="cd-days">0</span><small>days</small></div>
      <div><span id="cd-hours">00</span><small>hours</small></div>
      <div><span id="cd-mins">00</span><small>minutes</small></div>
      <div><span id="cd-secs">00</span><small>seconds</small></div>
    </div>

    <p class="muted">We started dating in 2013 and never stopped collecting inside jokes. On October 8th, 2025 we are making it official on our 13 year anniversary.</p>

    <div class="row" role="group" aria-label="Primary actions">
      <a id="venmoBtn" class="cta primary magnetic" target="_blank" rel="noopener">Open Registry</a>
      <a href="#story" class="cta secondary magnetic">Our story</a>
      <a id="playHero" href="#music" class="cta secondary magnetic">Play music</a>
    </div>
  </main>

  <svg class="divider" viewBox="0 0 1440 120" preserveAspectRatio="none" aria-hidden="true">
    <path d="M0,80 C360,140 1080,20 1440,80 L1440,120 L0,120 Z" class="gold"></path>
  </svg>

  <section id="music" data-reveal>
    <div class="container music">
      <div class="card" style="padding: 18px;">
        <h2>Music</h2>
        <p class="lead">A few songs that feel like us. Click a track to play.</p>

        <!-- visualizer -->
        <canvas id="viz" width="800" height="64" style="width:100%; height:64px; display:block; border-radius:12px; background:rgba(0,0,0,.04); border:1px solid rgba(0,0,0,.08);"></canvas>

        <audio id="player" preload="metadata" controls playsinline style="width: 100%; margin: 8px 0 10px;"></audio>
        <button id="playAuto" class="cta secondary" style="margin-top: 6px;">Play music</button>
        <p id="audioStatus" class="muted" style="margin-top: 6px;"></p>
        <ul id="tracklist" class="tracklist" aria-label="Playlist"></ul>
      </div>
    </div>
  </section>

  <section id="story" data-reveal>
    <div class="container card" style="padding: 18px;">
      <h2>Our Story</h2>
      <p>We met at Ashbrook High School, all the way back in 2013. There really aren't many ways to describe the things we've been through together. We started dating at 15 and now we're 27. That's a whole lotta years to experience life with one other person, especially considering our brains weren't even fully developed when we met. I mean, we're 27 and I'm still not convinced our brains are fully developed. Granted, I know that they are - I learned that at the nut hut, after all.</p>
    </div>
  </section>

  <section id="gallery" data-reveal>
    <div class="container">
      <h2>Photos</h2>
      <p class="lead">
        We have been dating since 2013, when we were both 15. It's been almost 12 years now and we're still glued to the hip. We've gone through everything together, grown up together, and spent years watching each other mature and develop into actual adult human beings together. It's time to start a new adventure, and we'd love for you to celebrate with us.
      </p>
      <div class="gallery-grid" id="photoGrid">
        <img loading="lazy" class="col-8" src="assets/photos/edward-1.jpg" alt="By the stone bridge">
        <img loading="lazy" class="col-4" src="assets/photos/edward-2.jpg" alt="Looking over the bridge">
        <img loading="lazy" class="col-4" src="assets/photos/edward-3.jpg" alt="By the fountain">
        <img loading="lazy" class="col-4" src="assets/photos/edward-4.jpg" alt="By the lake">
        <img loading="lazy" class="col-8" src="assets/photos/edward-5.jpg" alt="Close by the water">
        <img loading="lazy" class="col-6" src="assets/photos/edward-6.jpg" alt="Engagement photo">
        <img loading="lazy" class="col-6" src="assets/photos/edward-7.jpg" alt="Engagement photo">
      </div>
    </div>
  </section>

  <section id="registry" data-reveal>
    <div class="container registry">
      <div class="card box fancy">
        <h2>Registry</h2>
        <p class="lead">We are not asking for a Type R or a 24 karat gold Furby. If you would like to help with our honeymoon, we would be grateful.</p>
        <div class="row">
          <a id="venmoLink1" class="cta primary magnetic" target="_blank" rel="noopener">Contribute to honeymoon</a>
        </div>
        <div class="spacer"></div>
        <p class="muted">Thank you for the love and support.</p>
      </div>
      <div class="card qr">
        <p class="muted">Prefer scanning a code</p>
        <a id="venmoQRLink" href="https://venmo.com/code?user_id=2634431999246336599&created=1755619353" target="_blank" rel="noopener">
          <img src="assets/venmo-qr.jpg" alt="Venmo QR code for Edward Tobiasson" />
        </a>
        <p class="muted" style="margin-top: 8px;">Tap the QR to open Venmo</p>
      </div>
    </div>
  </section>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Photo viewer">
    <img alt="Enlarged photo" />
  </div>

  <button id="soundbar" class="soundbar" aria-label="Play music">Tap to play music</button>

  <footer>
    <div class="container">Built with love. Â© <span id="year"></span> <a href="silly/" style="font-size:12px; color: var(--muted); margin-left:12px; text-decoration: underline;">don't click me</a></div>
  </footer>

  <script>
    /* Settings */
    const VENMO_HANDLE = "Edward-Tobiasson";
    const PLAYLIST = [
      { title: "Yellow", file: "assets/music/yellow.mp3" },
      { title: "Froggy Went A Courtin'", file: "assets/music/froggy.mp3" },
      { title: "Crazyfrog", file: "assets/music/crazyfrog.mp3" },
      { title: "Scatman", file: "assets/music/scatman.mp3" }
    ];

    /* Wire up Venmo links */
    const venmoUrl = `https://venmo.com/u/${VENMO_HANDLE}`;
    const setVenmo = el => { if (el) el.href = venmoUrl; };
    setVenmo(document.getElementById("venmoBtn"));
    setVenmo(document.getElementById("venmoLink1"));

    /* Smooth scroll for in-page links */
    document.querySelectorAll('a[href^="#"]').forEach(a => {
      a.addEventListener('click', e => {
        const id = a.getAttribute('href').slice(1);
        const target = document.getElementById(id);
        if (target) { e.preventDefault(); target.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
      });
    });

    /* Lightbox for gallery */
    const lightbox = document.getElementById('lightbox');
    const lbImg = lightbox.querySelector('img');
    document.querySelectorAll('#photoGrid img').forEach(img => {
      img.addEventListener('click', () => { lbImg.src = img.src; lightbox.classList.add('open'); });
    });
    lightbox.addEventListener('click', () => lightbox.classList.remove('open'));
    document.addEventListener('keydown', e => { if (e.key === 'Escape') lightbox.classList.remove('open'); });

    /* Music playlist */
    const player = document.getElementById('player');
    const list = document.getElementById('tracklist');
    // Initial src so the native Play button works
    document.addEventListener('DOMContentLoaded', () => {
      if (PLAYLIST.length && player) player.src = PLAYLIST[0].file;
    });

    function renderTracks() {
      list.innerHTML = '';
      PLAYLIST.forEach((t, i) => {
        const li = document.createElement('li');
        const label = document.createElement('div');
        label.textContent = t.title;
        label.style.fontWeight = '700';
        const meta = document.createElement('span');
        meta.textContent = t.length || '';
        meta.className = 'muted';
        const controls = document.createElement('div');
        controls.className = 'track-controls';
        const btn = document.createElement('button');
        btn.textContent = 'Play';
        btn.addEventListener('click', () => playIndex(i));
        controls.appendChild(btn);
        li.appendChild(label);
        li.appendChild(meta);
        li.appendChild(controls);
        li.addEventListener('click', e => { if (e.target.tagName !== 'BUTTON') playIndex(i); });
        list.appendChild(li);
      });
    }
    function playIndex(i) {
      const t = PLAYLIST[i]; if (!t) return;
      player.src = t.file;
      player.play().catch(() => {});
    }
    renderTracks();

    // Music helpers
    let musicStarted = false;
    const ALLOW_KEY = 'allowMusic';
    function status(msg) {
      const el = document.getElementById('audioStatus');
      if (el) el.textContent = msg || '';
    }
    function startMusic() {
      if (musicStarted || !PLAYLIST.length) return;
      playIndex(0);
      player.play().then(() => { musicStarted = true; status(''); }).catch(() => { status('Press Play to start music'); });
    }
    const buttons = [document.getElementById('playHero'), document.getElementById('playAuto')].filter(Boolean);
    buttons.forEach(b => b.addEventListener('click', () => {
      startMusic(); localStorage.setItem(ALLOW_KEY, '1');
      const sb = document.getElementById('soundbar'); if (sb) sb.style.display='none';
    }));

    // Start on first user interaction anywhere
    function onFirstInteract() { startMusic(); localStorage.setItem(ALLOW_KEY, '1');
      document.removeEventListener('click', onFirstInteract);
      document.removeEventListener('keydown', onFirstInteract);
      document.removeEventListener('touchstart', onFirstInteract);
      document.removeEventListener('pointerdown', onFirstInteract);
    }
    document.addEventListener('click', onFirstInteract, { once: true });
    document.addEventListener('keydown', onFirstInteract, { once: true });
    document.addEventListener('touchstart', onFirstInteract, { once: true });
    document.addEventListener('pointerdown', onFirstInteract, { once: true });

    // Show a helpful message if the file cannot be loaded
    player.addEventListener('error', () => { status(`Could not load the audio file at ${player.src}. Check the filename and path.`); });

    // Soft autoplay on returning visits
    function softAutoStart() {
      if (localStorage.getItem(ALLOW_KEY)) setTimeout(() => { startMusic(); }, 150);
      else { const sb = document.getElementById('soundbar'); if (sb) sb.style.display = 'inline-flex'; }
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', softAutoStart); else softAutoStart();

    // Soundbar button
    const sb = document.getElementById('soundbar');
    if (sb) sb.addEventListener('click', () => { startMusic(); localStorage.setItem(ALLOW_KEY,'1'); sb.style.display='none'; });

    /* Year */
    document.getElementById('year').textContent = new Date().getFullYear();

    // Confetti burst when contributing
    function confettiBurst(x, y) {
      const c = document.createElement('canvas'); c.width = innerWidth; c.height = innerHeight; c.style.position='fixed'; c.style.inset='0'; c.style.pointerEvents='none'; c.style.zIndex='70'; document.body.appendChild(c);
      const ctx = c.getContext('2d');
      const pieces = Array.from({length: 80}).map(()=>({x, y, r: 4+Math.random()*6, a: Math.random()*Math.PI, vx: -3+Math.random()*6, vy: -6+Math.random()*-2, g: .15+Math.random()*.15, c: `hsl(${Math.random()*360},85%,60%)`}));
      let t = 0; (function tick(){
        ctx.clearRect(0,0,c.width,c.height);
        pieces.forEach(p=>{ p.vy += p.g; p.x += p.vx; p.y += p.vy; p.a += .08;
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle=p.c; ctx.fillRect(-p.r*.6,-p.r*.3,p.r,p.r*.6); ctx.restore();
        });
        if((t+=16)<900) requestAnimationFrame(tick); else c.remove();
      })();
    }
    ['venmoBtn','venmoLink1'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('click', () => {
        const r = el.getBoundingClientRect();
        confettiBurst(r.left+r.width/2, r.top+r.height/2);
      });
    });

    // Scroll reveal observer for sections
    (function(){
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('on'); io.unobserve(e.target); } });
      }, { threshold: 0.12 });
      document.querySelectorAll('[data-reveal]').forEach(el=> io.observe(el));
    })();

    // Countdown to Oct 8, 2025 00:00 ET
    (function(){
      const target = new Date('2025-10-08T00:00:00-04:00').getTime();
      const $d = document.getElementById('cd-days');
      const $h = document.getElementById('cd-hours');
      const $m = document.getElementById('cd-mins');
      const $s = document.getElementById('cd-secs');
      const pad = n => String(n).padStart(2,'0');
      function tick(){
        const now = Date.now();
        let diff = Math.max(0, target - now);
        const days  = Math.floor(diff / 86400000); diff -= days  * 86400000;
        const hours = Math.floor(diff / 3600000);  diff -= hours * 3600000;
        const mins  = Math.floor(diff / 60000);    diff -= mins  * 60000;
        const secs  = Math.floor(diff / 1000);
        if ($d) $d.textContent = days;
        if ($h) $h.textContent = pad(hours);
        if ($m) $m.textContent = pad(mins);
        if ($s) $s.textContent = pad(secs);
      }
      tick();
      setInterval(tick, 1000);
    })();

    // Magnetic buttons
    (function(){
      if (matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      const btns = document.querySelectorAll('.magnetic');
      btns.forEach(btn=>{
        let raf = null;
        function onMove(e){
          const r = btn.getBoundingClientRect();
          const x = e.clientX - (r.left + r.width/2);
          const y = e.clientY - (r.top + r.height/2);
          if (raf) cancelAnimationFrame(raf);
          raf = requestAnimationFrame(()=> btn.style.transform = `translate(${x*0.06}px, ${y*0.06}px)`);
        }
        function reset(){ btn.style.transform = 'translate(0,0)'; }
        btn.addEventListener('mousemove', onMove);
        btn.addEventListener('mouseleave', reset);
      });
    })();

    // Ken Burns + new scroll-in reveal for gallery images
    (function(){
      if (matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      const imgs = document.querySelectorAll('#photoGrid img');
      if (!imgs.length) return;

      // start hidden with a small offset
      imgs.forEach((img,i)=>{
        img.classList.add('ph-in');
        img.style.transitionDelay = `${Math.min(i*40, 240)}ms`;
      });

      const io = new IntersectionObserver(entries=>{
        entries.forEach(e=>{
          if(e.isIntersecting){
            e.target.classList.add('kb','ph-on');   // Ken Burns and fade/slide in
            e.target.classList.remove('ph-in');
            io.unobserve(e.target);
          }
        });
      }, { threshold: 0.35 });

      imgs.forEach(img=> io.observe(img));
    })();

    // Simple audio visualizer for #player
    (function(){
      if (matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      const audioEl = document.getElementById('player');
      const canvas = document.getElementById('viz');
      if (!audioEl || !canvas) return;
      const ctx = canvas.getContext('2d');
      let AC, analyser, src, raf;

      function draw(){
        const W = canvas.width, H = canvas.height;
        const buf = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(buf);
        ctx.clearRect(0,0,W,H);
        const bars = 48;
        const step = Math.floor(buf.length / bars);
        for(let i=0;i<bars;i++){
          const v = buf[i*step] / 255;
          const h = v * (H-8);
          const x = i * (W / bars) + 2;
          const w = (W / bars) - 4;
          const g = ctx.createLinearGradient(0,0,0,H);
          g.addColorStop(0, '#49C0B3');
          g.addColorStop(1, '#EDCD4F');
          ctx.fillStyle = g;
          ctx.fillRect(x, H - h - 2, w, h);
          ctx.fillStyle = 'rgba(0,0,0,.08)';
          ctx.fillRect(x, H - 2, w, 2);
        }
        raf = requestAnimationFrame(draw);
      }

      function wire(){
        try{
          AC = AC || new (window.AudioContext || window.webkitAudioContext)();
          if (!src) { src = AC.createMediaElementSource(audioEl); }
          analyser = analyser || AC.createAnalyser();
          analyser.fftSize = 512;
          src.connect(analyser);
          analyser.connect(AC.destination);
        }catch(e){ /* already wired or not supported */ }
      }

      audioEl.addEventListener('play', ()=>{
        wire();
        if (AC && AC.state === 'suspended') AC.resume();
        cancelAnimationFrame(raf);
        draw();
      });
      audioEl.addEventListener('pause', ()=> cancelAnimationFrame(raf));
      audioEl.addEventListener('ended', ()=> cancelAnimationFrame(raf));

      // Keep canvas crisp on HiDPI
      function resize(){
        const dpr = devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.round(rect.width * dpr);
        canvas.height = Math.round(rect.height * dpr);
      }
      addEventListener('resize', resize); resize();
    })();
  </script>
</body>
</html>
